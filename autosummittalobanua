-- ServerScriptService/CheckpointServer.server.lua
-- Checkpoint anti-miss untuk game milikmu (server-authoritative)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Koordinat checkpoint
local COORDS = {
    Vector3.new(-739.06, 23.46, 582.03),
    Vector3.new(11.84, 235.38, -211.59),
    Vector3.new(-272.35, 441.51, 1138.29),
    Vector3.new(-88.42, 1058.56, 1954.43),
    Vector3.new(-23.41, 1513.04, 2129.53),
    Vector3.new(-503.27, 1769.35, 2510.01),
    Vector3.new(-3079.68, 3317.34, 3134.89),
    Vector3.new(-3369.05, 4010.81, 3197.62),
    Vector3.new(-3650.31, 5058.53, 3694.24)
}

-- Buat folder & part checkpoint (trigger)
local folder = Instance.new("Folder")
folder.Name = "Checkpoints"
folder.Parent = workspace

local Pads = {}
for i, pos in ipairs(COORDS) do
    local p = Instance.new("Part")
    p.Name = ("Checkpoint_%d"):format(i)
    p.Size = Vector3.new(12, 12, 12)     -- cukup besar biar mudah kena
    p.Transparency = 1                    -- tak terlihat
    p.Anchored = true
    p.CanCollide = false
    p.CanTouch = true
    p.CFrame = CFrame.new(pos)
    p.Parent = folder

    Pads[i] = p
end

-- Debounce per pemain per checkpoint
local touchedOnce = {} -- [player] = { [index] = true }

local function getPlayerFromPart(part)
    if not part then return nil end
    local model = part:FindFirstAncestorOfClass("Model")
    if not model then return nil end
    local hum = model:FindFirstChildOfClass("Humanoid")
    if not hum then return nil end
    return Players:GetPlayerFromCharacter(model)
end

local function setCheckpoint(plr, index)
    if not plr then return end
    if not touchedOnce[plr] then touchedOnce[plr] = {} end
    if touchedOnce[plr][index] then return end  -- sudah dihitung

    -- Simpan progres pemain (leaderstats opsional)
    plr:SetAttribute("CheckpointIndex", index)
    touchedOnce[plr][index] = true
end

-- Touched handler
for idx, pad in ipairs(Pads) do
    pad.Touched:Connect(function(hit)
        local plr = getPlayerFromPart(hit)
        if plr then
            setCheckpoint(plr, idx)
        end
    end)
end

-- Radius check berkala (backup kalau Touched miss)
local CHECK_RADIUS = 8         -- stud
local HEARTBEAT_DT = 0.1       -- detik

task.spawn(function()
    while true do
        for _, plr in ipairs(Players:GetPlayers()) do
            local char = plr.Character
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            if hrp then
                -- Deteksi checkpoint terdekat dalam radius
                for idx, pos in ipairs(COORDS) do
                    if (hrp.Position - pos).Magnitude <= CHECK_RADIUS then
                        setCheckpoint(plr, idx)
                    end
                end
            end
        end
        task.wait(HEARTBEAT_DT)
    end
end)

-- (Opsional) bikin leaderstats untuk memantau di UI
Players.PlayerAdded:Connect(function(plr)
    local ls = Instance.new("Folder")
    ls.Name = "leaderstats"
    ls.Parent = plr

    local cp = Instance.new("IntValue")
    cp.Name = "Checkpoint"
    cp.Parent = ls

    plr:GetAttributeChangedSignal("CheckpointIndex"):Connect(function()
        local v = plr:GetAttribute("CheckpointIndex")
        if typeof(v) == "number" then
            cp.Value = v
        end
    end)
end)
